name: Build Multi-Arch Workflow
description: Workflow to build amd64 + arm64 images in parallel on their respective runners and then build a multi-architecture manifest once both images are built.

on:
    workflow_call:
      inputs:
        acr:
          description: 'IQGeos Azure container registry server name'
          type: string
          required: true
        dockerfile_path:
          description: 'Path to the dockerfile for this specific image build (injector, platform w/ module, editions)'
          type: string
          required: true
        docker_context:
          description: 'Build context for the docker image to reference'
          type: string
          required: true
        harbor:
          description: 'IQGeos Harbor container registry server name'
          type: string
          required: true
        module:
          description: 'Module to build (product, devdb, editions)'
          type: string
          required: true
        release_modules:
          description: 'Comma-separated list of modules to include in release repostitories'
          required: true
          type: string
        updated_tags:
          description: 'Comma-seperated list of new tags to retag multi arch image as once it is built (pre-release, latest)'
          type: string
        version:
          description: 'Version to build'
          type: string
          required: true
        build_id:
          description: 'Unique build ID per workflow run'
          type: string
          required: true
        shortened_version:
          description: 'Shortened Version to query utils-language-packs repo to copy language packs over for injector builds'
          type: string
        engineering_prefix:
          description: 'Engineering prefix to place multi arch images in Harbor'
          type: string
          default: devops_sandbox_engineering
        releases_prefix:
          description: 'Engineering prefix to place multi arch images in Harbor'
          type: string
          default: devops_sandbox_releases
        is_release:
          description: 'Whether this is a pre-release or release version'
          type: string
      secrets:
          GH_TOKEN:
              required: true
          REGISTRY_USERNAME:
              required: true
          REGISTRY_PASSWORD:
              required: true
          HARBOR_CLI_SECRET:
              required: true
          HARBOR_USERNAME:
            required: true

run-name: Build ${{ inputs.module }}:${{ inputs.version }}

jobs:
  lowercase-module:
    runs-on: ubuntu-latest
    outputs:
      module_lowercase: ${{ steps.lowercase.outputs.module_lowercase }}
    steps:
      - name: Convert module name to lowercase
        id: lowercase
        run: |
          MODULE_LOWERCASE=$(echo "${{ inputs.module }}" | tr '[:upper:]' '[:lower:]')
          echo "module_lowercase=$MODULE_LOWERCASE" >> $GITHUB_OUTPUT
          echo "Original module: ${{ inputs.module }}"
          echo "Lowercase module: $MODULE_LOWERCASE"
          
  build-arm64-image:
    needs: lowercase-module
    runs-on: arm64
    steps:
      - name: build-arm64-image
        uses: IQGeo/devops-engineering-ci-public-build-push-action@main
        with:
          dockerfile_path: ${{ inputs.dockerfile_path }}
          docker_context: ${{ inputs.docker_context }}
          version: ${{ inputs.version }}
          tag: ${{ inputs.build_id }}_arm-64
          platform: arm64
          module: ${{ inputs.module }}
          module_lowercase: ${{ needs.lowercase-module.outputs.module_lowercase }}
          acr: ${{ inputs.acr }}
          harbor: ${{ inputs.harbor }}
          registry_username : ${{ secrets.REGISTRY_USERNAME  }}
          registry_password : ${{ secrets.REGISTRY_PASSWORD  }}
          harbor_cli_secret : ${{ secrets.HARBOR_CLI_SECRET  }}
          harbor_username : ${{ secrets.HARBOR_USERNAME  }}
          gh_token: ${{ secrets.GH_TOKEN }}
          engineering_prefix: ${{ inputs.engineering_prefix }}
          shortened_version: ${{ inputs.shortened_version }}
  build-amd64-image:
    needs: lowercase-module
    runs-on: x64
    steps:
      - name: build-amd64-image
        uses: IQGeo/devops-engineering-ci-public-build-push-action@main
        with:
          dockerfile_path: ${{ inputs.dockerfile_path }}
          docker_context: ${{ inputs.docker_context }}
          version: ${{ inputs.version }}
          tag: ${{ inputs.build_id }}_amd-64
          platform: x64
          module: ${{ inputs.module }}
          module_lowercase: ${{ needs.lowercase-module.outputs.module_lowercase }}
          acr: ${{ inputs.acr }}
          harbor: ${{ inputs.harbor }}
          registry_username : ${{ secrets.REGISTRY_USERNAME  }}
          registry_password : ${{ secrets.REGISTRY_PASSWORD  }}
          harbor_cli_secret : ${{ secrets.HARBOR_CLI_SECRET  }}
          harbor_username : ${{ secrets.HARBOR_USERNAME  }}  
          gh_token: ${{ secrets.GH_TOKEN }}
          engineering_prefix: ${{ inputs.engineering_prefix }}
          shortened_version: ${{ inputs.shortened_version }}
  build-multi-arch:
    needs: [ lowercase-module, build-amd64-image, build-arm64-image ]
    runs-on: x64
    steps:
      - name: Debug
        run: |
          echo "${{ inputs.updated_tags }}"
      - name: build-multi-arch
        uses: IQGeo/devops-engineering-ci-public-multi-arch-action@main
        with:
          version: ${{ inputs.version }}
          amd_tag: ${{ inputs.build_id }}_amd-64
          arm_tag: ${{ inputs.build_id }}_arm-64
          updated_tags: ${{ inputs.updated_tags }}
          module: ${{ needs.lowercase-module.outputs.module_lowercase }}
          release_modules: ${{ inputs.release_modules }}
          acr: ${{ inputs.acr }}
          harbor: ${{ inputs.harbor }}
          registry_username : ${{ secrets.REGISTRY_USERNAME  }}
          registry_password : ${{ secrets.REGISTRY_PASSWORD  }}
          harbor_cli_secret : ${{ secrets.HARBOR_CLI_SECRET  }}
          harbor_username : ${{ secrets.HARBOR_USERNAME  }}
          engineering_prefix: ${{ inputs.engineering_prefix }}
          releases_prefix: ${{ inputs.releases_prefix }}
          is_release: ${{ inputs.is_release }}
